
DROP TABLE SCOPUS_2017Y_5Y_FAU_AFF_NU CASCADE CONSTRAINTS PURGE;
DROP TABLE SCOPUS_2017Y_5Y_FAU_AFF_CT CASCADE CONSTRAINTS PURGE;
CREATE TABLE SCOPUS_2017Y_5Y_FAU_AFF_CT AS
SELECT DISTINCT A.EID, A.CIT_COUNT, NVL( B.COUNTRY_CODE, 'NONE') AS COUNTRY_CODE, C.L_ASJC_CODE, A.PUBLICATION_YEAR
FROM SCOPUS_2017_DOCUMENT A
LEFT OUTER JOIN SCOPUS_2017Y_FIRST_AUTHOR_AFF B
ON A.EID = B.EID
INNER JOIN (  
  SELECT DISTINCT EID, DECODE(ASJC_CODE, NULL, 'NONE',(SUBSTR(ASJC_CODE,1,2) ||'00')) AS L_ASJC_CODE 
  FROM SCOPUS_2014_CLASS_ASJC
) C
ON A.EID = C.EID
WHERE A.PUBLICATION_YEAR BETWEEN '2014' AND '2016';
CREATE INDEX IDX_SCOPUS_FAUAFF_5Y_NU_EID ON  SCOPUS_2017Y_5Y_FAU_AFF_CT(EID);
CREATE INDEX IDX_SCOPUS_FAUAFF_5Y_NU_CT ON SCOPUS_2017Y_5Y_FAU_AFF_CT(COUNTRY_CODE);
CREATE INDEX IDX_SCOPUS_FAUAFF_5Y_NU_CCNT ON SCOPUS_2017Y_5Y_FAU_AFF_CT(CIT_COUNT);
CREATE INDEX IDX_SCOPUS_FAUAFF_5Y_NU_ASJ ON SCOPUS_2017Y_5Y_FAU_AFF_CT(L_ASJC_CODE);
CREATE INDEX IDX_SCOPUS_FAUAFF_5Y_NU_YEAR ON SCOPUS_2017Y_5Y_FAU_AFF_CT(PUBLICATION_YEAR);

DROP TABLE SCOPUS_2017Y_KEYWORD_FAUAF_BCT CASCADE constraints PURGE;
CREATE TABLE SCOPUS_2017Y_KEYWORD_FAUAF_BCT NOLOGGING AS
SELECT A.EID, A.L_ASJC_CODE, A.PUBLICATION_YEAR, B.KEYWORD
FROM (
	SELECT DISTINCT A.EID, A.L_ASJC_CODE, A.PUBLICATION_YEAR
    FROM SCOPUS_2017Y_5Y_FAU_AFF_CT A
) A
INNER JOIN SCOPUS_2017Y_KEYWORD B
ON A.EID = B.EID
WHERE B.KEYWORD IS NOT NULL;

CREATE INDEX IDX_SCOPUS_2017Y_FAUCTKB_EID ON SCOPUS_2017Y_KEYWORD_FAUAF_BCT (EID);
CREATE INDEX IDX_SCOPUS_2017Y_FAUCTKB_ASJC ON SCOPUS_2017Y_KEYWORD_FAUAF_BCT (L_ASJC_CODE);
CREATE INDEX IDX_SCOPUS_2017Y_FAUCTKB_KW ON SCOPUS_2017Y_KEYWORD_FAUAF_BCT (KEYWORD);
CREATE INDEX IDX_SCOPUS_2017Y_FAUCTKB_PY ON SCOPUS_2017Y_KEYWORD_FAUAF_BCT (PUBLICATION_YEAR);

DROP TABLE SCOPUS_2017Y_KEYWORD_FAUCT_R CASCADE constraints PURGE;
CREATE TABLE SCOPUS_2017Y_KEYWORD_FAUCT_R NOLOGGING AS
SELECT RANK() OVER (PARTITION BY A.L_ASJC_CODE ORDER BY DOC_CNT DESC) AS RANKING, A.KEYWORD, A.L_ASJC_CODE, A.DOC_CNT
FROM (
    SELECT A.KEYWORD, A.L_ASJC_CODE, COUNT(DISTINCT A.EID) AS DOC_CNT
    FROM SCOPUS_2017Y_KEYWORD_FAUAF_BCT A
    WHERE A.L_ASJC_CODE IN ('1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
    )
    GROUP BY A.KEYWORD, A.L_ASJC_CODE
) A;
CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUCTR_R ON SCOPUS_2017Y_KEYWORD_FAUCT_R(RANKING);
CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUCTR_K ON SCOPUS_2017Y_KEYWORD_FAUCT_R(KEYWORD);
CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUCTR_A ON SCOPUS_2017Y_KEYWORD_FAUCT_R(L_ASJC_CODE);


-- 연도-분야별 키워드 통계
DROP TABLE SCOPUS_2017Y_KEYWORD_FAUST CASCADE constraints PURGE;
CREATE TABLE SCOPUS_2017Y_KEYWORD_FAUST NOLOGGING AS
SELECT A.KEYWORD, A.L_ASJC_CODE, A.PUBLICATION_YEAR, A.DOC_CNT
FROM (
    SELECT A.KEYWORD, A.L_ASJC_CODE, A.PUBLICATION_YEAR, COUNT(DISTINCT EID) AS DOC_CNT
    FROM SCOPUS_2017Y_KEYWORD_FAUAF_BCT A
    WHERE A.L_ASJC_CODE IN ('1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
    )
    GROUP BY A.KEYWORD, A.L_ASJC_CODE, A.PUBLICATION_YEAR
) A
INNER JOIN (
    SELECT DISTINCT KEYWORD, L_ASJC_CODE
    FROM SCOPUS_2017Y_KEYWORD_FAUCT_R
    WHERE RANKING <= 1000
    ORDER BY KEYWORD
) B
ON A.KEYWORD = B.KEYWORD AND A.L_ASJC_CODE = B.L_ASJC_CODE;

CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUS_K ON SCOPUS_2017Y_KEYWORD_FAUST(KEYWORD);
CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUS_A ON SCOPUS_2017Y_KEYWORD_FAUST(L_ASJC_CODE);
CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUS_P ON SCOPUS_2017Y_KEYWORD_FAUST(PUBLICATION_YEAR);
CREATE INDEX IDX_SCOPUS_2017Y_KEY_FAUS_R ON SCOPUS_2017Y_KEYWORD_FAUST(RANKING);


-- 최근 5년 연도별 키워드 통계
DROP TABLE SCOPUS_2017Y_KEY_FAUSTY CASCADE constraints PURGE;
CREATE TABLE SCOPUS_2017Y_KEY_FAUSTY NOLOGGING AS
SELECT A.KEYWORD, A.PUBLICATION_YEAR, A.DOC_CNT
FROM (
    SELECT A.KEYWORD, A.PUBLICATION_YEAR, COUNT(DISTINCT EID) AS DOC_CNT
    FROM SCOPUS_2017Y_KEYWORD_FAUAF_BCT A
    WHERE A.L_ASJC_CODE IN ('1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
    ) AND A.KEYWORD IN (
	      SELECT DISTINCT KEYWORD
	      FROM SCOPUS_2017Y_KEYWORD_FAUCT_R
	      WHERE RANKING <= 1000
    ) 
    GROUP BY A.KEYWORD, A.PUBLICATION_YEAR
) A;

CREATE INDEX IDX_SCOPUS_2017Y_KEY_5YFAUS_K ON SCOPUS_2017Y_KEY_FAUSTY(KEYWORD);
CREATE INDEX IDX_SCOPUS_2017Y_KEY_5YFAUS_P ON SCOPUS_2017Y_KEY_FAUSTY(PUBLICATION_YEAR);


-- 최근 5년 제1저자 국가별 통계
DROP TABLE SCOPUS_2017Y_FAUCT_COMP_ST CASCADE CONSTRAINTS PURGE;	
CREATE TABLE SCOPUS_2017Y_FAUCT_COMP_ST AS
SELECT COUNTRY_CODE, COUNT(DISTINCT EID) AS P_BY_CO, SUM(CIT_COUNT) AS C_BY_CO
FROM (
	SELECT DISTINCT COUNTRY_CODE, EID, CIT_COUNT
    FROM SCOPUS_2017Y_5Y_FAU_AFF_CT
    WHERE L_ASJC_CODE IN ('1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
        ) AND A.PUBLICATION_YEAR BETWEEN '2014' AND '2016'
)
GROUP BY COUNTRY_CODE;

-- 최근 5년 제1저자 국가별 통계
DROP TABLE SCOPUS_2017Y_FAUCT_DOC_STAT CASCADE CONSTRAINTS PURGE;	
CREATE TABLE SCOPUS_2017Y_FAUCT_DOC_STAT AS
SELECT  COUNT(DISTINCT EID) AS P, SUM(CIT_COUNT) AS C
FROM (
	SELECT DISTINCT EID, CIT_COUNT
    FROM SCOPUS_2017Y_5Y_FAU_AFF_CT
    WHERE L_ASJC_CODE IN ('1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
        ) AND A.PUBLICATION_YEAR BETWEEN '2014' AND '2016'
)
GROUP BY COUNTRY_CODE;

-- 제 1저자 국가별 키워드 수집
DROP TABLE SCOPUS_2017Y_5Y_FAUAFFCT_KB CASCADE CONSTRAINTS PURGE;	
CREATE TABLE SCOPUS_2017Y_5Y_FAUAFFCT_KB AS
SELECT A.EID, A.KEYWORD, B.COUNTRY_CODE, B.CIT_COUNT
FROM SCOPUS_2017Y_KEYWORD A
inner JOIN (
    SELECT DISTINCT COUNTRY_CODE, EID, CIT_COUNT
    FROM SCOPUS_2017Y_5Y_FAU_AFF_CT
    WHERE L_ASJC_CODE IN (
    	'1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
    )
) B
ON A.EID = B.EID;

CREATE INDEX IDX_FAU_AFF_EID ON SCOPUS_2017Y_5Y_FAUAFFCT_KB(EID);
CREATE INDEX IDX_FAU_AFF_KW ON SCOPUS_2017Y_5Y_FAUAFFCT_KB(KEYWORD);
CREATE INDEX IDX_FAU_AFF_CT ON SCOPUS_2017Y_5Y_FAUAFFCT_KB(COUNTRY_CODE);
CREATE INDEX IDX_FAU_AFF_CCNT ON SCOPUS_2017Y_5Y_FAUAFFCT_KB(CIT_COUNT);

DROP TABLE SCOPUS_2017Y_5Y_FAUAFCT_KYAB CASCADE CONSTRAINTS PURGE;	
CREATE TABLE SCOPUS_2017Y_5Y_FAUAFCT_KYAB AS
SELECT A.EID, A.KEYWORD, B.PUBLICATION_YEAR, B.L_ASJC_CODE, B.CIT_COUNT
FROM SCOPUS_2017Y_KEYWORD A
inner JOIN (
    SELECT DISTINCT COUNTRY_CODE, EID, CIT_COUNT, PUBLICATION_YEAR, L_ASJC_CODE
    FROM SCOPUS_2017Y_5Y_FAU_AFF_CT
    WHERE L_ASJC_CODE IN (
    	'1000', '1100',
        '1300', '1500',
        '1600', '1700',
        '1800', '1900',
        '2100', '2200',
        '2300', '2400',
        '2500', '2600',
        '2700', '2800',
        '3000', '3100',
        '3400', '3500'
    )
) B
ON A.EID = B.EID;
CREATE INDEX IDX_FAU_AFF_KYA_EID ON SCOPUS_2017Y_5Y_FAUAFCT_KYAB(EID);
CREATE INDEX IDX_FAU_AFF_KYA_KW ON SCOPUS_2017Y_5Y_FAUAFCT_KYAB(KEYWORD);
CREATE INDEX IDX_FAU_AFF_KYA_YEAR ON SCOPUS_2017Y_5Y_FAUAFCT_KYAB(PUBLICATION_YEAR);
CREATE INDEX IDX_FAU_AFF_KYA_ASJC ON SCOPUS_2017Y_5Y_FAUAFCT_KYAB(L_ASJC_CODE);
CREATE INDEX IDX_FAU_AFF_KYA_CCNT ON SCOPUS_2017Y_5Y_FAUAFCT_KYAB(CIT_COUNT);

DROP TABLE SCOPUS_2017Y_5Y_FAUAFFCT_K_ST CASCADE CONSTRAINTS PURGE;	
CREATE TABLE SCOPUS_2017Y_5Y_FAUAFFCT_K_ST AS
SELECT KEYWORD, COUNTRY_CODE, COUNT(EID) AS D_CNT, SUM(CIT_COUNT) AS C_CNT
FROM SCOPUS_2017Y_5Y_FAUAFFCT_KB
WHERE KEYWORD IN (
   SELECT DISTINCT KEYWORD
   FROM SCOPUS_2017Y_KEYWORD_FAUCT_R
   WHERE RANKING <= 1000
)
GROUP BY KEYWORD, COUNTRY_CODE;

CREATE INDEX IDX_FAU_AFF_KBS_KW ON SCOPUS_2017Y_5Y_FAUAFFCT_K_ST(KEYWORD);
CREATE INDEX IDX_FAU_AF_KBS_CT ON SCOPUS_2017Y_5Y_FAUAFFCT_K_ST(COUNTRY_CODE);


DROP TABLE SCOPUS_2017Y_5Y_FAUAFFCT_KTOT CASCADE CONSTRAINTS PURGE;	
CREATE TABLE SCOPUS_2017Y_5Y_FAUAFFCT_KTOT AS
SELECT KEYWORD, COUNT(EID) AS D_CNT, SUM(CIT_COUNT) AS C_CNT
FROM (
	SELECT DISTINCT KEYWORD, EID, CIT_COUNT
	FROM SCOPUS_2017Y_5Y_FAUAFFCT_KB
)
WHERE KEYWORD IN (
   SELECT DISTINCT KEYWORD
   FROM SCOPUS_2017Y_KEYWORD_FAUCT_R
   WHERE RANKING <= 1000
)
GROUP BY KEYWORD, COUNTRY_CODE;

CREATE INDEX IDX_FAU_AFF_KBS_T_KW ON SCOPUS_2017Y_5Y_FAUAFFCT_KTOT(KEYWORD);
CREATE INDEX IDX_FAU_AF_KBS_T_CT ON SCOPUS_2017Y_5Y_FAUAFFCT_KTOT(COUNTRY_CODE);


-- 국가별, 키워드 활동도, 영향력 통계 추출
DROP TABLE SCOPUS_2017Y_5Y_FAUCT_K_ACT CASCADE CONSTRAINTS PURGE;
CREATE TABLE  SCOPUS_2017Y_5Y_FAUCT_K_ACT NOLOGGING AS 
SELECT 
   A.KEYWORD, 
   A.COUNTRY_CODE,
   -- 활동도 계산
   ((A.P_BY_KEY_BY_CO/P_BY_KEY) / (A.P_BY_CO / A.P)) AS ACTIVATION,
   -- 영향력 계산
   ((A.C_BY_KEY_BY_CO/C_BY_KEY) / (A.C_BY_CO / A.C)) AS EFFECTION
FROM (
	SELECT
    	 A.KEYWORD,
    	 A.COUNTRY_CODE,
        A.P_BY_KEY_BY_CO,
        A.C_BY_KEY_BY_CO,
        -- P
        (SELECT I.P FROM SCOPUS_2017Y_FAUCT_DOC_STAT I) AS P,
        -- C
        (SELECT J.C FROM SCOPUS_2017Y_FAUCT_DOC_STAT J) AS C,
        -- P_BY_CO
        (SELECT I.P_BY_CO FROM SCOPUS_2017Y_FAUCT_COMP_ST I WHERE I.COUNTRY_CODE = A.COUNTRY_CODE) AS P_BY_CO,
        --C_BY_CO
        (SELECT J.C_BY_CO FROM SCOPUS_2017Y_FAUCT_COMP_ST J WHERE J.COUNTRY_CODE = A.COUNTRY_CODE) AS C_BY_CO,
        -- P_BY_KEY
        (SELECT K.D_CNT FROM SCOPUS_2017Y_5Y_FAUAFFCT_KTOT K WHERE K.KEYWORD = A.KEYWORD) AS P_BY_KEY,
        -- C_BY_KEY
        (SELECT L.C_CNT FROM SCOPUS_2017Y_5Y_FAUAFFCT_KTOT L WHERE L.KEYWORD = A.KEYWORD) AS C_BY_KEY
    FROM (
      SELECT  A.KEYWORD, A.COUNTRY_CODE,A.D_CNT AS P_BY_KEY_BY_CO, A.C_CNT AS C_BY_KEY_BY_CO
      FROM SCOPUS_2017Y_5Y_FAUAFFCT_K_ST A
    ) A
) A;
